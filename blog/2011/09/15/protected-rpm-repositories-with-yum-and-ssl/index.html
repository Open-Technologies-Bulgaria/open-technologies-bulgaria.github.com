
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Protected RPM repositories with yum and SSL - Open Technologies Bulgaria</title>
  <meta name="author" content="Open Technologies Bulgaria">

  
  <meta name="description" content="In this article I&#8217;m going to describe a simple way to set-up RPM repositories with access control using only standard tools such as yum, SSL &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://otb.bg/blog/2011/09/15/protected-rpm-repositories-with-yum-and-ssl">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Open Technologies Bulgaria" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=Russo+One" rel="stylesheet" type="text/css" />

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-17204134-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="no-sidebar"  >
  <header role="banner"><hgroup>
<div id="logo-container">
<div id="logo">Open Technologies <em>Bulgaria</em></div>
<div id="logo-sub"><em>research, test &amp; deploy</em></div>
</div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:otb.bg" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Protected RPM repositories with yum and SSL</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-09-15T19:40:00+03:00" pubdate data-updated="true">Sep 15<span>th</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>In this article I&#8217;m going to describe a simple way to set-up RPM repositories with access control using only standard tools such as yum, SSL and Apache.</p>

<p><strong>Objective:</strong><br />
Create RPM repository with access control. Access is allowed only for some systems and forbidden for the rest. This is a similar to what Red Hat Network does.</p>

<p><strong>Solution:</strong><br />
We&#8217;re going to use yum and Apache capabilities to work with SSL certificates. The client side (yum) will identify itself using SSL certificate and the server (Apache) will use this information to control the access.</p>

<p><strong>Client side set-up:</strong><br /></p>

<ol>
  <li>
Yum version 3.2.27 or newer supports SSL certificates for client authentication. This version is available in Red Hat Enterprise Linux 6. 
  </li>

  <li>
First you need to generate a private key and certificate using OpenSSL:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># openssl genrsa -out /var/lib/yum/client.key 1024
</span><span class='line'>Generating RSA private key, 1024 bit long modulus
</span><span class='line'>....++++++
</span><span class='line'>.......++++++
</span><span class='line'>e is 65537 (0x10001)
</span><span class='line'>
</span><span class='line'># openssl req -new -x509 -text -key /var/lib/yum/client.key -out /var/lib/yum/client.cert
</span><span class='line'>You are about to be asked to enter information that will be incorporated
</span><span class='line'>into your certificate request.
</span><span class='line'>What you are about to enter is what is called a Distinguished Name or a DN.
</span><span class='line'>There are quite a few fields but you can leave some blank
</span><span class='line'>For some fields there will be a default value,
</span><span class='line'>If you enter '.', the field will be left blank.
</span><span class='line'>-----
</span><span class='line'>Country Name (2 letter code) [XX]:BG
</span><span class='line'>State or Province Name (full name) []:Sofia
</span><span class='line'>Locality Name (eg, city) [Default City]:Sofia
</span><span class='line'>Organization Name (eg, company) [Default Company Ltd]:Open Technologies Bulgaria
</span><span class='line'>Organizational Unit Name (eg, section) []:IT
</span><span class='line'>Common Name (eg, your name or your server's hostname) []:
</span><span class='line'>Email Address []:no-spam@otb.bg</span></code></pre></td></tr></table></div></figure>
  </li>

  <li>
For better security you can change file permissions of <em>client.key</em>:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># chmod 600 /var/lib/yum/client.key</span></code></pre></td></tr></table></div></figure>
  </li>

  <li>
You need to define the protected repository in a .repo file. It needs to look something like this:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat /etc/yum.repos.d/protected.repo
</span><span class='line'>[protected]
</span><span class='line'>name=SSL protected repository
</span><span class='line'>baseurl=https://repos.example.com/protected
</span><span class='line'>enabled=1
</span><span class='line'>gpgcheck=1
</span><span class='line'>gpgkey=https://repos.example.com/RPM-GPG-KEY
</span><span class='line'>
</span><span class='line'>sslverify=1
</span><span class='line'>sslclientcert=/var/lib/yum/client.cert
</span><span class='line'>sslclientkey=/var/lib/yum/client.key</span></code></pre></td></tr></table></div></figure>
  </li>

  <li>
If you use self-signed server certificate you can specify  <em>sslverify=0</em>, but this is not recommended.
  </li>
</ol>


<p>Whenever yum tries to reach the URL of the repository it will identify itself using the specified certificate.</p>

<p><strong>Server side set-up:</strong><br /></p>

<ol>
  <li>
Install and configure the <em>mod_ssl</em> module for Apache.
  </li>

  <li>
Create a directory for the repository which will be available over HTTPS.
  </li>

  <li>
In the repository directory add <em>.htaccess</em>, which looks something like this:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Action rpm-protected /cgi-bin/rpm.cgi
</span><span class='line'>AddHandler rpm-protected .rpm .drpm
</span><span class='line'>SSLVerifyClient optional_no_ca</span></code></pre></td></tr></table></div></figure>
  </li>

  <li>
The <em>Action</em> and <em>AddHandler</em> directives instruct Apache to run the <em>rpm.cgi</em> CGI script every time someone tries to access files with extension .rpm and .drpm.
  </li>

  <li>
The <em>SSLVerifyClient</em> directive tells Apache that the http client may present a valid certificate but it has not to be (successfully) verifyable.
For more information on this configuration please see
<a href="http://www.modssl.org/docs/2.1/ssl_reference.html#ToC13">http://www.modssl.org/docs/2.1/ssl_reference.html#ToC13</a>.
  </li>

  <li>
The simplest form of <em>rpm.cgi</em> script may look like this:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>
</span><span class='line'>if [ "$SSL_CLIENT_M_SERIAL" == "9F938211B53B4F44" ]; then
</span><span class='line'>    echo "Content-type: application/x-rpm"
</span><span class='line'>    echo "Content-length: $(stat --printf='%s' $PATH_TRANSLATED)"
</span><span class='line'>    echo
</span><span class='line'>
</span><span class='line'>    cat $PATH_TRANSLATED
</span><span class='line'>else
</span><span class='line'>    echo "Status: 403"
</span><span class='line'>    echo
</span><span class='line'>fi</span></code></pre></td></tr></table></div></figure>
  </li>

  <li>
The script will allow access to a client which uses a certificate with serial number <em>9F938211B53B4F44</em>. Other clients will be denied access and the server will return standard 403 error code.
  </li>
</ol>


<p><strong>In practice:</strong><br />
The above set-up is very basic and only demonstrates the technology behind this. In a real world configuration you will need some more tools to make this really usable.</p>

<p>Open Technologies Bulgaria, Ltd. has developed a custom solution for our customers based on the above example called Voyager. It features a Drupal module, a CGI script and a client side yum plugin.</p>

<p>The Drupal module acts as web interface to the system and allows some basic tasks. Administrators can define software channels and subscription expiration. Customers can register and entitle their systems to particular channels. The functionality is similar to Red Hat Network but without all the extra features which we don&#8217;t need.</p>

<p>The CGI script acts as a glue between the client side and the Drupal backend. It will read information about client credentials and act as first line of defence against non-authorized access. Then it will communicate with the Drupal database and get more information about this customer. If everything is OK then access will be allowed.</p>

<p>The yum plugin has the task to communicate with the Drupal backend and dynamically update repository definitions based on available subscriptions. Then it will send a request for the RPM file back to the Apache server where the CGI script will handle it.</p>

<p>The client side also features a tool to generate the client certificate and register the system to the server.</p>

<p>All communications are entirely over HTTPS.</p>

<p>Our custom solution has the advantage that it is simple and easy to maintain as well as easy to use. It integrates well with other plugins (e.g. yum-presto for delta rpm support and yum-rhnplugin) and can be used via yum or PackageKit which are the standard package management tools on Red Hat Enterprise Linux 6.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Alexander Todorov</span></span>

      








  


<time datetime="2011-09-15T19:40:00+03:00" pubdate data-updated="true">Sep 15<span>th</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/apache/'>Apache</a>, <a class='category' href='/blog/categories/rpm/'>RPM</a>, <a class='category' href='/blog/categories/ssl/'>SSL</a>, <a class='category' href='/blog/categories/yum/'>yum</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://otb.bg/blog/2011/09/15/protected-rpm-repositories-with-yum-and-ssl/" data-via="" data-counturl="http://otb.bg/blog/2011/09/15/protected-rpm-repositories-with-yum-and-ssl/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2011/08/22/opencode-systems-improves-software-testing-with-open-source-tools/" title="Previous Post: Opencode Systems improves software testing with open source tools">&laquo; Opencode Systems improves software testing with open source tools</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/01/04/bebekarta-runs-on-drupal/" title="Next Post: BebeKarta runs on Drupal">BebeKarta runs on Drupal &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/07/13/mission-impossible-abrt-bugzilla-plugin-on-rhel6/">Mission impossible - ABRT Bugzilla plugin on RHEL6</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/12/combining-pdf-files-on-the-command-line/">Combining PDF files on the command line</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/14/thinkpad-mini-dock-design-flaw/">ThinkPad Mini Dock design flaw</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/27/fosscourse-migrates-to-github/">fosscourse migrates to GitHub</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/04/bebekarta-runs-on-drupal/">BebeKarta runs on Drupal</a>
      </li>
    
  </ul>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Open Technologies Bulgaria -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'otb-blog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://otb.bg/blog/2011/09/15/protected-rpm-repositories-with-yum-and-ssl/';
        var disqus_url = 'http://otb.bg/blog/2011/09/15/protected-rpm-repositories-with-yum-and-ssl/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
